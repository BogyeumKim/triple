<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<style>

</style>
<body>
<!--

    유저 아이디 : <input type="text"  id="regUserId">
    </br>
    유저 비번 : <input type="text" id="regUserPw">
    </br>
    유저 닉넴 : <input type="text" id="regUserNick">
    </br>
    <button type="button" id="subBtn">회원 가입</button>
    <button type="button" id="loginBtn">로그인</button>
    </br>
    <button onclick="showPopUp()">
        <img th:src="@{/img/naverLoginBtn.png}" width="200" height="50">
    </button>

    </br>
    <button id="testBtn">테스트</button>
    <div class="testDiv"></div>

-->
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="login-tab" data-bs-toggle="tab" href="#login-form">
                             로그인
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="register-tab" data-bs-toggle="tab" href="#register-form">회원가입</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="login-form">

                                <div class="mb-3">
                                    <label for="login-id" class="form-label">아이디</label>
                                    <input type="text" class="form-control" id="login-id" placeholder="ID를 입력하세요.">
                                </div>
                                <div class="mb-3">
                                    <label for="login-password" class="form-label">비밀번호</label>
                                    <input type="password" class="form-control" id="login-password" placeholder="PW를 입력하세요.">
                                </div>
                                <button type="submit" id="loginBtn" class="btn btn-primary w-100">로그인</button>

                            <div class="text-center mt-3">
                                <a class="btn btn-outline-info" onclick="showPopUp()" >
                                    <img th:src="@{/img/naverBtn.png}" alt="네이버 로그인" style="max-height:50px;">
                                </a>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="register-form">

                                <div class="mb-3">
                                    <label for="register-username" class="form-label">아이디</label>
                                    <input type="text" class="form-control" id="register-username" placeholder="ID를 입력하세요.">
                                </div>
                                <div class="mb-3">
                                    <label for="register-nick" class="form-label">닉네임</label>
                                    <input type="email" class="form-control" id="register-nick" placeholder="닉네임을 입력하세요.">
                                </div>
                                <div class="mb-3">
                                    <label for="register-password" class="form-label">비밀번호</label>
                                    <input type="password" class="form-control" id="register-password" placeholder="비밀번호를 입력하세요.">
                                </div>
                                <button type="submit" id="subBtn" class="btn btn-primary w-100">회원가입</button>

                            <div class="text-center mt-3">
                                <a class="btn btn-outline-info" onclick="showPopUp()" >
                                    <img th:src="@{/img/naverBtn.png}" alt="네이버 회원가입" style="max-height:50px;">
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 부트스트랩 JS 및 Popper.js, jQuery 라이브러리 링크 -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
</body>
<script th:inline="javascript">


    /*initTest();
    async function initTest(){
        const testAPI = await fetch('/member/test', { method: "GET"});
        const data = await testAPI.json();

        const testDiv = document.querySelector('.testDiv');
        const spanDom = document.createElement('span');
        spanDom.classList.add('testClass');
        spanDom.textContent = `{ID:${data.user_id}}, NICK:${data.user_nick}}`;
        testDiv.appendChild(spanDom);

        clickEvent();
    }*/

    const registerDom = document.querySelector('#register-tab');
    registerDom.addEventListener('click',()=>{
        let user_id = document.getElementById("register-username");
        let user_pw = document.getElementById("register-password");
        let user_nick = document.getElementById("register-nick");
        user_id.value='';
        user_pw.value='';
        user_nick.value=''
    })

    const loginDom = document.querySelector('#login-tab');
    loginDom.addEventListener('click',()=>{
        let user_id = document.getElementById("login-id");
        let user_pw = document.getElementById("login-password");
        user_id.value='';
        user_pw.value='';
    })

  const subBtn = document.getElementById("subBtn");
  subBtn.addEventListener("click",registerFetch);

  const loginBtn = document.getElementById("loginBtn");
  loginBtn.addEventListener("click",loginFetch);

  function loginFetch(){
      const user_id = document.getElementById("login-id").value;
      const user_pw = document.getElementById("login-password").value;
      const url = '/login';
      const data = JSON.stringify({user_id,user_pw});
      console.log(data)
      fetch(url,{method : "POST" , body:data,headers:{'Content-Type': 'application/json'}})
          .then( response =>{
              if(response.status === 200){
                let token = response.headers.get("Authorization");
                console.log(token);
                localStorage.setItem("Authorization",token);
                alert("로그인 성공!!")
                // memberInfoFetch();
              }else{
                  alert("로그인 실패ㅠ")
                  throw new Error("로그인 실패");
              }
          }).catch(error => console.error(error))
  }


  async function memberInfoFetch() {
      const accessToken = localStorage.getItem("Authorization");
      const res  = await fetch('/member/info',{
          method: "GET", headers: {
              Authorization : `Bearer ${accessToken}`
          }
      });
      if(res.status === 401){
          // refreshToken을 이용해 갱신
         const refreshed = await refreshToken();
         if(refreshed){
             memberInfoFetch();
         } else {
             console.log("토큰 갱신 실패")
         }
      }
      else if(res.status === 404){
          console.log("로그인 다시하세요")
      }
      else{
          const data =await res.json();
          console.log(data);
      }
  }


  async function refreshToken() {
      const res = await fetch('/member/newToken', { method: "POST", credentials: "include" }); // 쿠키에 담긴 리프레쉬 토큰을 포함하여 API 요청하려면 credentials 속성 필요.
      if (res.status === 200) {
          let token = res.headers.get("Authorization");
          localStorage.setItem("Authorization", token);
          console.log('토큰변경완료'+token);
          return true;
      } else {
          console.error("토큰 변경실패");
          return false;
      }
  }


  function registerFetch(){
      const user_id = document.getElementById("register-username").value;
      const user_pw = document.getElementById("register-password").value;
      const user_nick = document.getElementById("register-nick").value;
      const url = '/member/';
      const data = JSON.stringify({user_id,user_pw,user_nick});
      console.log(data)
      fetch(url,{method : "POST" , body:data,headers:{'Content-Type': 'application/json'}})
            .then( response =>{
                console.log(response)
                if(response.status === 201){
                    alert("회원가입 완료!");
                    // return response.json(); // Response 객체를 JSON 형태로 파싱하여 반환
                }else {
                    alert("회원가입 실패ㅠ");
                    throw new Error('회원가입 실패');
                }
            })
          // .then(data => { console.log(data)})
          .catch(error => console.error(error))

  }



  /*<![CDATA[*/
  function showPopUp(){
      var state = [[${state}]];

      const uri = 'https://nid.naver.com/oauth2.0/authorize?' +
          'response_type=code' +
          '&client_id=nPHj7peh5QV2gkYPN7Xv' +
          '&state='+state +
          '&redirect_uri=http://115.85.183.26:8080/outh2/naver/login';

      var popup = window.open(uri, "팝업 테스트", "width=400, height=300, top=10, left=10");

      function popupCallback(event) {
          console.log(event);
          if (event.data === "naverLoginSuccess") {
              popup.close();
              alert("로긴 성공!");
          } else if (event.data === "naverRegSuccess") {
              popup.close();
              alert("가입 성공!");
          } else {
              popup.close();
              alert("가입 실패 ㅠ");
          }
          window.removeEventListener("message", popupCallback);
      }
      window.addEventListener("message", popupCallback);
  }
  /*]]>*/

</script>
</html>